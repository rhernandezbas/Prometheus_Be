name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: root
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd /root/Prometheus_Be
          git pull origin main
          
          # Detener todos los contenedores relacionados
          docker-compose down
          
          # Verificar y matar cualquier proceso que use el puerto 8090
          PORT_PID=$(lsof -t -i:8090 || echo "")
          if [ ! -z "$PORT_PID" ]; then
            echo "Killing process using port 8090: $PORT_PID"
            kill -9 $PORT_PID
          fi
          
          # Esperar un momento para asegurar que los puertos se liberen
          sleep 5
          
          # Iniciar los contenedores
          docker-compose up -d --build
